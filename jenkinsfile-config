// Definitions here

pipeline {

// Set up local variables for your pipeline
    environment {
        // test variable: 0=success, 1=fail; must be string
        doError = '0'
        BUILD_USER = ''
    }

    agent any

    stages {

        stage('Slack - Notify Start Build'){
                steps {
                     slackSend channel: '#builds',
                     message: "Started ${env.JOB_NAME} with build #${BUILD_NUMBER}"
                }
            }

        stage('Gradle Build') {
            steps {
                sh './gradlew build'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                  withSonarQubeEnv(installationName: 'sonarqube', credentialsId: 'sonarqube_integration') {
                    sh './gradlew sonarqube'
                  }
            }
        }

        stage('Publish to App Center') {
                    steps {
                        appCenter apiToken: 'f1e91523c76ccd9caa11a3e5894f78efc72bcdf9', appName: 'FunCalc', buildVersion: '',
                        distributionGroups: 'Collaborators', notifyTesters: true, ownerName: 'mfresco95@gmail.com',
                        pathToApp: 'app/build/outputs/apk/debug/app-debug.apk', pathToDebugSymbols: '', pathToReleaseNotes: '',
                        releaseNotes: 'Test first release'
                    }
                }

        stage("Quality Gates Check") {
            steps {
                waitForQualityGate abortPipeline: true
            }
        }


    }

    post{

        success{
                slackSend channel: '#builds',
                message: "${env.JOB_NAME} - #${BUILD_NUMBER} finished with status: *${currentBuild.currentResult}*.",
                color: 'good'
        }
        failure{
                slackSend channel: '#builds',
                message: "${env.JOB_NAME} - #${BUILD_NUMBER} finished with status: *${currentBuild.currentResult}*.",
                color: 'danger'
        }


    }


}
